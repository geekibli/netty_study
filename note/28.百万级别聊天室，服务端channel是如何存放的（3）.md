# 28.ç™¾ä¸‡çº§åˆ«èŠå¤©å®¤ï¼ŒæœåŠ¡ç«¯channelæ˜¯å¦‚ä½•å­˜æ”¾çš„ï¼ˆ3ï¼‰


> ç™¾ä¸‡çº§åˆ«èŠå¤©å®¤ï¼ŒæœåŠ¡ç«¯channelæ˜¯å¦‚ä½•å­˜æ”¾çš„ ï¼Ÿï¼Ÿï¼Ÿ
>


## channelèƒ½ä¸èƒ½å­˜åˆ°Redis ï¼Ÿ

channelä¸å¯ä»¥å­˜å‚¨åˆ°Redis,å®ƒçš„åº•å±‚æ˜¯æ“ä½œç³»ç»Ÿæ–‡ä»¶æè¿°ç¬¦ï¼Œè¿˜ä¼šè®¾è®¡åˆ°TCPçš„é“¾è·¯ã€‚

## é‚£å­˜åˆ°Redisé‡Œé¢çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

æ˜¯channelçš„åæ ‡ï¼Œæœºå™¨IPå’Œç«¯å£ï¼Œä»¥åŠchannelåŒå‘ç»‘å®šçš„session id


 ```java
public class SessionCache implements Serializable {

    private String userId;

    private String sessionId;

    private ImNode node;
}
```

è¿™ä¸ªSessionå°±æ˜¯å­˜æ”¾åœ¨redisä¸­çš„æ•°æ®ã€‚

å½“ç„¶äº†ï¼Œç”¨æˆ·å¯èƒ½ä¸æ­¢ä¸€ä¸ªé€šé“ï¼Œ

```java
public class UserCache {

    private String userId;

    // session id
    private Map<String, SessionCache> map = new LinkedHashMap<String, SessionCache>(10);
}
```

## å¦‚ä½•æ“ä½œè¿™äº›Session ?

### æ“ä½œSessionCacheçš„æ¥å£

```java
public interface SessionCacheDAO {

    void save(SessionCache s);

    SessionCache get(String sessionId);

    void remove(String sessionId);
}
```

### æ“ä½œUserCacheçš„æ¥å£

```java
public interface UserCacheDAO {

    void save(UserCache u);

    void remove(String userId, String sessionId);

    void addSession(String userId, SessionCache s);

    UserCache get(String userId);
}
```

## ä½¿ç”¨åˆ†å¸ƒå¼Sessionçš„åœºæ™¯

### 1. ç™»å½•æˆåŠŸä¹‹å,æ·»åŠ Session

- åˆ›å»ºæœ¬åœ°Session
- åˆ›å»ºSessionCache (sessionId, node)
- åˆ›å»ºUserCache (userId, sessionCache)


### 2. ç”¨æˆ·ä¸‹çº¿æ—¶ï¼Œåˆ é™¤Session

å‡ ä¹å’Œä¸Šé¢ğŸ‘†åˆ›å»ºSessionç›¸å…³ ï¼š 

- åˆ é™¤UserCacheä¸­çš„SessionCache: removeSession(userId, sessionId)
- åˆ é™¤Redisä¸­çš„SessionCache: remove(sessionId)
- åˆ é™¤æœ¬åœ°Session: clear(sessionId)


### 3. æ¶ˆæ¯è½¬å‘

- æ ¹æ®ç”¨æˆ·idï¼Œæ‰¾åˆ°æ‰€æœ‰æœåŠ¡å™¨ä¸Šçš„è¯¥ç”¨æˆ·çš„ä¼šè¯åˆ—è¡¨
- ä¸ºæ¯ä¸€ä¸ªä¼šè¯è½¬å‘æ¶ˆæ¯



## å…¶ä»–

å¦‚æœæ˜¯åƒä¸‡çº§åˆ«ï¼ŒæœåŠ¡ç«¯çš„Channelå­˜å‚¨åº”è¯¥åšä»€ä¹ˆä¼˜åŒ–å‘¢ï¼Ÿ