# 54 å‘½ä»¤æ”¶é›†å™¨æ¨¡å—å®ç°ä»¥åŠç®€ä»‹


## ä»€ä¹ˆæ˜¯å‘½ä»¤æ”¶é›†å™¨

é¦–å…ˆæˆ‘ä»¬çš„å•ä½“IMæ¶æ„çš„é‡ç‚¹ä¾§é‡äºé€šè®¯éƒ¨åˆ†å’ŒæœåŠ¡ç«¯çš„è®¾è®¡ï¼Œç”¨æˆ·ç«¯çš„æ³¨å†Œé¡µé¢å’Œç™»å½•é¡µé¢ç­‰æˆ‘ä»¬éƒ½é‡‡ç”¨æ§åˆ¶å°çš„æ–¹å¼æ¨¡æ‹Ÿã€‚

å‘½ä»¤æ”¶é›†å™¨çš„èŒèƒ½å°±æ˜¯ç”¨æ¥æ”¶é›†å®¢æˆ·ç«¯è¾“å…¥çš„æŒ‡ä»¤ï¼Œè¿›è€Œå®Œæˆç”¨æˆ·åç»­çš„æ“ä½œã€‚


## å‘½ä»¤æ”¶é›†å™¨éƒ½æœ‰å“ªäº›


é¦–å…ˆæœ‰ä¸€ä¸ªå‘½ä»¤æ”¶é›†çš„æ¥å£

```java
public interface BaseCommand {

	//è·å–å‘½ä»¤çš„key
	String getKey();

	//è·å–å‘½ä»¤çš„æç¤ºä¿¡æ¯
	String getTip();

	//ä»æ§åˆ¶å°æå– ä¸šåŠ¡æ•°æ®
	void exec(Scanner scanner);

}
```

å®ç°ç±»åˆ†åˆ«æœ‰ ğŸ‘‡

- ChatConsoleCommandï¼š æ”¶é›†ç”¨æˆ·èŠå¤©æ¶ˆæ¯
- ClientCommandMenuï¼š èœå•æ˜¾ç¤º
- LoginConsoleCommandï¼š ç”¨æˆ·ç™»å½•æŒ‡ä»¤æ”¶é›†
- LogoutConsoleCommandï¼š ç™»å‡ºæŒ‡ä»¤



## æŒ‡ä»¤æ”¶é›†å™¨å·¥ä½œåŸç†


- é¦–å…ˆæ˜¯å®¢æˆ·ç«¯å¯åŠ¨çš„æ—¶å€™ï¼ŒåŠ è½½æ‰€æœ‰çš„å‘½ä»¤
- å®¢æˆ·ç«¯å¯åŠ¨ä¹‹åï¼Œæ§åˆ¶å°å¯ä»¥æ‰“å°å·²ç»åŠ è½½çš„å‘½ä»¤æ”¶é›†å™¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®¢æˆ·ç«¯ç›®å‰æä¾›äº†å“ªäº›åŠŸèƒ½
- ç„¶åç”¨æˆ·æ ¹æ®æ§åˆ¶å°æç¤ºçš„æŒ‡ä»¤å°±å¯ä»¥è¿›è¡ŒåŠŸèƒ½ä½¿ç”¨äº†ï¼Œæ¯”å¦‚ç™»å½•ï¼ŒèŠå¤©ç­‰


```java
  //å¯åŠ¨èŠå¤©å®¢æˆ·ç«¯
private static void startChatClient(ApplicationContext context) {
	CommandController commandClient = context.getBean(CommandController.class);
	
	// åŠ è½½æ‰€æœ‰å‘½ä»¤
	commandClient.initCommandMap();
	try {
		commandClient.commandThreadRunning();

	} catch (InterruptedException e) {
		e.printStackTrace();
	}
}
```

### åŠ è½½æ‰€æœ‰å‘½ä»¤æ”¶é›†å™¨ï¼Œå­˜æ”¾åˆ°ä¸€ä¸ªmapä¸­

```java
public void initCommandMap() {
	commandMap = new HashMap<>();
	commandMap.put(clientCommandMenu.getKey(), clientCommandMenu);
	commandMap.put(chatConsoleCommand.getKey(), chatConsoleCommand);
	commandMap.put(loginConsoleCommand.getKey(), loginConsoleCommand);
	commandMap.put(logoutConsoleCommand.getKey(), logoutConsoleCommand);
	clientCommandMenu.setAllCommand(commandMap);
}
```

å®¢æˆ·ç«¯å®Œæˆè¿æ¥ä¹‹åå‘¢ï¼Œå‘½ä»¤æ”¶é›†æœåŠ¡å¯åŠ¨ã€‚

ä¸€ä¸ªwhileå¾ªç¯ï¼Œä¸æ–­ç›‘å¬å®¢æˆ·ç«¯è¾“å…¥çš„æ•°æ®ï¼Œç„¶åè§£ææ•°æ®ï¼Œæ ¹æ®æ•°æ®ä¸åŒçš„ç±»å‹ï¼Œåšå‡ºä¸åŒçš„å¤„ç†ã€‚å…·ä½“å¯ä»¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„switchåˆ†æµã€‚

```java
public void commandThreadRunning() throws InterruptedException {
	Thread.currentThread().setName("å‘½ä»¤çº¿ç¨‹");

	while (true) {
		//å»ºç«‹è¿æ¥
		while (connectFlag == false) {
			//å¼€å§‹è¿æ¥
			startConnectServer();
			waitCommandThread();

		}
		//å¤„ç†å‘½ä»¤
		while (null != session) {

			Scanner scanner = new Scanner(System.in);
			clientCommandMenu.exec(scanner);
			String key = clientCommandMenu.getCommandInput();
			BaseCommand command = commandMap.get(key);

			if (null == command) {
				System.err.println("æ— æ³•è¯†åˆ«[" + command + "]æŒ‡ä»¤ï¼Œè¯·é‡æ–°è¾“å…¥!");
				continue;
			}


			switch (key) {
				case ChatConsoleCommand.KEY:
					command.exec(scanner);
					startOneChat((ChatConsoleCommand) command);
					break;

				case LoginConsoleCommand.KEY:
					command.exec(scanner);
					startLogin((LoginConsoleCommand) command);
					break;

				case LogoutConsoleCommand.KEY:
					command.exec(scanner);
					startLogout(command);
					break;

			}
		}
	}
}
```


## ç¯å¢ƒé…ç½®

ç‚¹å‡»Help -> Edit custom vm Optionsï¼Œ æ·»åŠ å¦‚ä¸‹

```
-Deditable.java.test.console=true
```

**ç„¶åé‡å¯IDEç”Ÿæ•ˆï¼ï¼ï¼**


## æµ‹è¯•ç¨‹åº

ç®€æ˜“ä»£ç æ”¶é›†å‘½ä»¤æµ‹è¯•ç¨‹åºã€‚

```
 @Test
	public void testCommandController() {
		initCommandMap();
		//å¤„ç†å‘½ä»¤
		while (true) {

			//èœå•è¾“å…¥
			Scanner scanner = new Scanner(System.in);
			clientCommandMenu.exec(scanner);
			String key = clientCommandMenu.getCommandInput();

			//æ ¹æ®èœå•è¾“å…¥ï¼Œé€‰æ‹©æ­£ç¡®çš„å‘½ä»¤æ”¶é›†å™¨
			BaseCommand command = commandMap.get(key);

			if (null == command) {
				System.err.println("æ— æ³•è¯†åˆ«[" + key + "]æŒ‡ä»¤ï¼Œè¯·é‡æ–°è¾“å…¥!");
				continue;
			}

			//æ‰§è¡Œå‘½ä»¤æ”¶é›†å™¨
			switch (key) {
				case LoginConsoleCommand.KEY:
					command.exec(scanner);
					Logger.info("æœ¬æ¬¡è¾“å…¥çš„ username ä¸ºï¼š");
					Logger.info(((LoginConsoleCommand) command).getUserName());
					Logger.info("æœ¬æ¬¡è¾“å…¥çš„ password ä¸ºï¼š");
					Logger.info(((LoginConsoleCommand) command).getPassword());

//                    startLogin((LoginConsoleCommand) command);
					break;

				case LogoutConsoleCommand.KEY:
					command.exec(scanner);
//                    startLogout((LoginConsoleCommand) command);
					break;
			}
		}
	}

	public void initCommandMap() {
		commandMap = new HashMap<>();
		LoginConsoleCommand loginConsoleCommand = new LoginConsoleCommand();
		LogoutConsoleCommand logoutConsoleCommand = new LogoutConsoleCommand();
		commandMap.put(clientCommandMenu.getKey(), clientCommandMenu);
		commandMap.put(loginConsoleCommand.getKey(), loginConsoleCommand);
		commandMap.put(logoutConsoleCommand.getKey(), logoutConsoleCommand);
		clientCommandMenu.setAllCommand(commandMap);
	}
```



### æµ‹è¯•ç»“æœ

```
è¯·è¾“å…¥æŸä¸ªæ“ä½œæŒ‡ä»¤ï¼š[menu] 0->show æ‰€æœ‰å‘½ä»¤ | 1->ç™»å½• | 10->é€€å‡º | 
1
è¯·è¾“å…¥ç”¨æˆ·ä¿¡æ¯(id@password)  
2
è¯·æŒ‰ç…§æ ¼å¼è¾“å…¥(id@password):
```



## è‡ªå®šä¹‰protobufç¼–è§£ç å™¨

ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒNettyè‡ªå¸¦çš„ç¼–è§£ç å™¨éƒ½ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œéœ€è¦æˆ‘ä»¬è‡ªå·±å®šä¹‰ç¼–è§£ç å™¨ã€‚


### è‡ªå®šä¹‰ç¼–ç å™¨

ç¼–ç é€»è¾‘ï¼šæ·»åŠ å†…å®¹
- é­”æ•°
- ç‰ˆæœ¬
- æ•°æ®é•¿åº¦
- æ•°æ®

```java
@Slf4j
public class SimpleProtobufEncoder extends MessageToByteEncoder<ProtoMsg.Message> {

	@Override
	protected void encode(ChannelHandlerContext ctx, ProtoMsg.Message msg, ByteBuf out) throws Exception {
		encode0(msg, out);
	}

	public static void encode0(ProtoMsg.Message msg, ByteBuf out) {
		out.writeShort(ProtoInstant.MAGIC_CODE);
		out.writeShort(ProtoInstant.VERSION_CODE);

		byte[] bytes = msg.toByteArray();// å°† ProtoMsg.Message å¯¹è±¡è½¬æ¢ä¸ºbyte

		// åŠ å¯†æ¶ˆæ¯ä½“
		/*ThreeDES des = channel.channel().attr(Constants.ENCRYPT).get();
		byte[] encryptByte = des.encrypt(bytes);*/
		int length = bytes.length;// è¯»å–æ¶ˆæ¯çš„é•¿åº¦

		Logger.cfo("encoder length=" + length);

		// å…ˆå°†æ¶ˆæ¯é•¿åº¦å†™å…¥ï¼Œä¹Ÿå°±æ˜¯æ¶ˆæ¯å¤´
		out.writeInt(length);
		// æ¶ˆæ¯ä½“ä¸­åŒ…å«æˆ‘ä»¬è¦å‘é€çš„æ•°æ®
		out.writeBytes(bytes);
	}

}
```



### è‡ªå®šä¹‰è§£ç å™¨

```java
@Slf4j
public class SimpleProtobufDecoder extends ByteToMessageDecoder {

	@Override
	protected void decode(ChannelHandlerContext ctx, ByteBuf in, List<Object> out) throws Exception {

		Object outmsg = decode0(ctx, in);
		if (outmsg != null) {
			// è·å–ä¸šåŠ¡æ¶ˆæ¯
			out.add(outmsg);
		}
	}

	public static Object decode0(ChannelHandlerContext ctx, ByteBuf in) throws InvalidFrameException, InvalidProtocolBufferException {
		// æ ‡è®°ä¸€ä¸‹å½“å‰çš„readIndexçš„ä½ç½®
		in.markReaderIndex();
		// åˆ¤æ–­åŒ…å¤´é•¿åº¦
		if (in.readableBytes() < 8) {// ä¸å¤ŸåŒ…å¤´
			return null;
		}
		//è¯»å–é­”æ•°
		short magic = in.readShort();
		if (magic != ProtoInstant.MAGIC_CODE) {
			String error = "å®¢æˆ·ç«¯å£ä»¤ä¸å¯¹:" + ctx.channel().remoteAddress();
			//å¼‚å¸¸è¿æ¥ï¼Œç›´æ¥æŠ¥é”™ï¼Œå…³é—­è¿æ¥
			throw new InvalidFrameException(error);
		}
		//è¯»å–ç‰ˆæœ¬
		short version = in.readShort();
		if (version != ProtoInstant.VERSION_CODE) {
			String error = "åè®®çš„ç‰ˆæœ¬ä¸å¯¹:" + ctx.channel().remoteAddress();
			//å¼‚å¸¸è¿æ¥ï¼Œç›´æ¥æŠ¥é”™ï¼Œå…³é—­è¿æ¥
			throw new InvalidFrameException(error);
		}
		// è¯»å–ä¼ é€è¿‡æ¥çš„æ¶ˆæ¯çš„é•¿åº¦ã€‚
		int length = in.readInt();

		// é•¿åº¦å¦‚æœå°äº0
		if (length < 0) {
			// éæ³•æ•°æ®ï¼Œå…³é—­è¿æ¥
			ctx.close();
		}

		if (length > in.readableBytes()) {// è¯»åˆ°çš„æ¶ˆæ¯ä½“é•¿åº¦å¦‚æœå°äºä¼ é€è¿‡æ¥çš„æ¶ˆæ¯é•¿åº¦
			// é‡ç½®è¯»å–ä½ç½®
			in.resetReaderIndex();
			return null;
		}
		Logger.cfo("decoder length=" + in.readableBytes());

		byte[] array;
		if (in.hasArray()) {
			array = new byte[length];
			in.readBytes(array, 0, length);
		} else {
			//ç›´æ¥ç¼“å†²
			array = new byte[length];
			in.readBytes(array, 0, length);
		}

		// å­—èŠ‚è½¬æˆå¯¹è±¡
		return ProtoMsg.Message.parseFrom(array);
	}
}
```


## æ•´ä½“æµ‹è¯•

```
@Test
	public void testProtobufDecoder() {
		ChannelInitializer i = new ChannelInitializer<EmbeddedChannel>() {
			protected void initChannel(EmbeddedChannel ch) {
				// åŠåŒ…çš„å¤„ç†
				ch.pipeline().addLast("decoder", new SimpleProtobufDecoder());
//                ch.pipeline().addLast("encoder", new SimpleProtobufEncoder());
				ch.pipeline().addLast("inHandler", new MockLoginRequestHandler());

			}
		};

		EmbeddedChannel channel = new EmbeddedChannel(i);
		for (int j = 0; j < 100; j++) {
			ByteBuf bytebuf = Unpooled.buffer(1024).order(ByteOrder.BIG_ENDIAN);
			ProtoMsg.Message pkg = buildLoginMsg(new User());
			SimpleProtobufEncoder.encode0(pkg, bytebuf);
			channel.writeInbound(bytebuf);
			channel.flush();
		}

		try {
			Thread.sleep(Integer.MAX_VALUE);
		} catch (InterruptedException e) {
			e.printStackTrace();
		}
	}
```

**æµ‹è¯•ç»“æœï¼š**

```
SimpleProtobufEncoder:encode0:encoder length=97
SimpleProtobufDecoder:decode0:decoder length=97
[main|TestProtobufMsg$MockLoginRequestHandler:channelRead] |>  id:=99 
[main|TestProtobufMsg$MockLoginRequestHandler:channelRead] |>  content:=4ac37b58-b5f8-4e06-891e-5cb051c87bea 
SimpleProtobufEncoder:encode0:encoder length=98
SimpleProtobufDecoder:decode0:decoder length=98
[main|TestProtobufMsg$MockLoginRequestHandler:channelRead] |>  id:=100 
[main|TestProtobufMsg$MockLoginRequestHandler:channelRead] |>  content:=0631a7a4-1c8c-434e-980f-907d559ba8bc 
```

