# 41 æ·±å…¥çº¿ç¨‹çŠ¶æ€çš„æœ¬è´¨å’Œç”±æ¥

æ€è€ƒï¼Œçº¿ç¨‹çš„çŠ¶æ€æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ 

## åœ¨javaä¸­ï¼Œçº¿ç¨‹çš„çŠ¶æ€æœ‰å‡ ç§ï¼Œæ˜¯å¦‚ä½•å®šä¹‰çš„?

Javaä¸­çº¿ç¨‹çŠ¶æ€å®šä¹‰åœ¨Threadç±»ä¸­ï¼Œä¸‹é¢æ˜¯è´´å‡ºæ¥çš„æºç ï¼š 
```java

public enum State {
	/**
	 * Thread state for a thread which has not yet started.
	 */
	NEW,

	/**
	 * Thread state for a runnable thread.  A thread in the runnable
	 * state is executing in the Java virtual machine but it may
	 * be waiting for other resources from the operating system
	 * such as processor.
	 */
	RUNNABLE,

	/**
	 * Thread state for a thread blocked waiting for a monitor lock.
	 * A thread in the blocked state is waiting for a monitor lock
	 * to enter a synchronized block/method or
	 * reenter a synchronized block/method after calling
	 * {@link Object#wait() Object.wait}.
	 */
	BLOCKED,

	/**
	 * Thread state for a waiting thread.
	 * A thread is in the waiting state due to calling one of the
	 * following methods:
	 * <ul>
	 *   <li>{@link Object#wait() Object.wait} with no timeout</li>
	 *   <li>{@link #join() Thread.join} with no timeout</li>
	 *   <li>{@link LockSupport#park() LockSupport.park}</li>
	 * </ul>
	 *
	 * <p>A thread in the waiting state is waiting for another thread to
	 * perform a particular action.
	 *
	 * For example, a thread that has called <tt>Object.wait()</tt>
	 * on an object is waiting for another thread to call
	 * <tt>Object.notify()</tt> or <tt>Object.notifyAll()</tt> on
	 * that object. A thread that has called <tt>Thread.join()</tt>
	 * is waiting for a specified thread to terminate.
	 */
	WAITING,

	/**
	 * Thread state for a waiting thread with a specified waiting time.
	 * A thread is in the timed waiting state due to calling one of
	 * the following methods with a specified positive waiting time:
	 * <ul>
	 *   <li>{@link #sleep Thread.sleep}</li>
	 *   <li>{@link Object#wait(long) Object.wait} with timeout</li>
	 *   <li>{@link #join(long) Thread.join} with timeout</li>
	 *   <li>{@link LockSupport#parkNanos LockSupport.parkNanos}</li>
	 *   <li>{@link LockSupport#parkUntil LockSupport.parkUntil}</li>
	 * </ul>
	 */
	TIMED_WAITING,

	/**
	 * Thread state for a terminated thread.
	 * The thread has completed execution.
	 */
	TERMINATED;
}
```


**Javaä¸­6ä¸­çŠ¶æ€çš„å«ä¹‰:**

<img src="https://oscimg.oschina.net/oscnet/up-e87ac3af0eef2063e5311b49cdc23d880e0.png" width=750 height=210>


è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒThreadç±»ä¸­è¿˜æœ‰ä¸€ä¸ªå˜é‡threadStatusï¼Œ ç”¨æ¥è¡¨ç¤ºçº¿ç¨‹çŠ¶æ€ï¼Œè¿™ä¸ªå’Œä¸Šé¢å®šä¹‰çš„çŠ¶æ€æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ æŸä¸ªæ—¶åˆ»çº¿ç¨‹çŠ¶æ€æ˜¯å…¶ä¸­çš„ä¸€ä¸ªå€¼å—ï¼Ÿ

```java
java.lang.Thread#threadStatus

/* Java thread status for tools,
 * initialized to indicate thread 'not yet started'
 */

private volatile int threadStatus = 0;
```


## é¦–å…ˆäº†è§£ä¸€ä¸‹Javaçº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„å…³ç³»


### ä¸€å¯¹ä¸€æ¨¡å‹

åˆ›å»ºä¸€ä¸ªç”¨æˆ·çº¿ç¨‹çš„åŒæ—¶ï¼Œåˆ›å»ºä¸€ä¸ªå†…æ ¸çº¿ç¨‹ã€‚

<img src="https://oscimg.oschina.net/oscnet/up-15a570a284bffb21e0548d1d132cba1148e.png" width=350 height=230> 


é¦–å…ˆäº†è§£ä¸€ä¸‹JVMä¸­çš„çº¿ç¨‹ï¼Œè¿™å—è®¾è®¡äº†3ä¸ªç±»ï¼Œjava.long.Threadã€JavaThreadå’ŒOSThread.

- java.long.Threadï¼š è¿™ä¸ªæ˜¯å­˜æ”¾åœ¨JVMå †ä¸­çš„çº¿ç¨‹å¯¹è±¡ï¼Œæ˜¯æˆ‘ä»¬javaç¨‹åºå‘˜å¹³æ—¶ä¼šç”¨åˆ°çš„çº¿ç¨‹ç±»
- Threadæ˜¯C++å®šä¹‰çš„çº¿ç¨‹åŸºç±»ï¼Œé™¤äº†OSThreadç±»ä»¥å¤–ï¼Œä½œä¸ºå…¶ä»–çº¿ç¨‹ç±»çš„åŸºç±»ï¼Œå®ƒåŒ…å«äº†OSThreadå¯¹è±¡çš„æŒ‡é’ˆ
- JavaThreadæ˜¯C++å®šä¹‰çš„çº¿ç¨‹ç±»ï¼Œæˆ‘ä»¬åœ¨Javaå±‚åˆ›å»ºçš„çº¿ç¨‹å¯¹è±¡ä¼šä½¿ç”¨JavaThreadå¯¹è±¡æ¥è¡¨ç¤ºï¼Œå®ƒåŒ…å«äº†æŒ‡å‘çº¿ç¨‹oopçš„æŒ‡é’ˆ
- OSThreadæ˜¯C++å®šä¹‰çš„çº¿ç¨‹ï¼Œå®ƒä¸å’Œå…¶ä»–çº¿ç¨‹æ„æˆç»§æ‰¿å…³ç³»ï¼Œå®ƒæ˜¯JVMå¯¹ä¸åŒæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹çš„ç»Ÿä¸€æŠ½è±¡ï¼Œå®ƒç»´æŠ¤äº†æ“ä½œç³»ç»Ÿçš„å¥æŸ„ï¼Œç”¨äºè·å–æ“ä½œç³»ç»Ÿçš„çº¿ç¨‹



### çº¿ç¨‹çš„å®é™…çŠ¶æ€

JVMä¸­èµ·ç æœ‰ä¸‰ç§çŠ¶æ€çš„å˜åŒ–ï¼š

- ä¸€ç§æ˜¯Javaè§„èŒƒä¸­çš„çº¿ç¨‹çŠ¶æ€(java_thread -> threadObj())
- ä¸€ç§æ˜¯è¡¨ç¤ºJVMå…³è”çš„ç³»ç»Ÿçº¿ç¨‹çš„çŠ¶æ€ï¼ˆthread->OsThreadï¼‰
- ä¸€ç§æ˜¯jvmçº¿ç¨‹åœ¨åšè½¬æ¢çš„ä¸€ç§çŠ¶æ€, æ˜¯vmè‡ªå·±çš„çŠ¶æ€

æˆ‘ä»¬é‡ç‚¹å…³æ³¨ç¬¬ä¸€ç§ã€‚  

ä¸‹é¢æ˜¯JavaThreadç±»çš„å®šä¹‰ï¼Œå®ƒæŒ‡å‘äº†æˆ‘ä»¬åœ¨Javaå±‚åˆ›å»ºçš„å¯¹è±¡çš„ oop::threadObj

<img src="https://oscimg.oschina.net/oscnet/up-5b97919be31f1f7b6d959f09da4cd696a9d.png" width=750 height=200>

### JavaThreadå¦‚ä½•åˆ›å»º_threadObjå’ŒJavaçº¿ç¨‹ä¹‹é—´çš„çŠ¶æ€çš„å…³ç³»ï¼Ÿ 


æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹JVM_StartThreadçš„å®ç°ï¼š 

<img src="https://oscimg.oschina.net/oscnet/up-9cb774e3623ea6311220ca5d3d91c0e53ba.png" width=750 height=200>


- é¦–å…ˆä¼šåˆ›å»ºä¸€ä¸ªJavaThread
- ç„¶åè°ƒç”¨prepareæ–¹æ³•ï¼Œå°†è¿”å›å€¼èµ‹å€¼ç»™native_thread
- æœ€åè°ƒç”¨startNativeThreadæ–¹æ³•

é‚£ä¹ˆJavaThreadæ„é€ å™¨éƒ½åšäº†ä»€ä¹ˆå‘¢ï¼Ÿ 

æ„é€ å™¨å†…éƒ¨åˆ›å»ºäº†ä¸€ä¸ªOSThreadï¼Œå†…æ ¸çº¿ç¨‹


é‚£ä¸‹é¢çœ‹ä¸€ä¸‹prepareæ–¹æ³•ï¼š 


<img src="https://oscimg.oschina.net/oscnet/up-59a5dbde1700ff9f99a743c13054e91bf27.png" width=750 height=460>


è¿™é‡Œå¯ä»¥çœ‹åˆ°jni_threadï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬åœ¨javaå †ä¸­çš„å¯¹è±¡ï¼Œprepareæ–¹æ³•å°±æ˜¯è¦æ“ä½œjavaå †ä¸­çš„å¯¹è±¡è½¬æ¢æˆC++ç¨‹åºå¯ä»¥æ“ä½œçš„æŒ‡é’ˆ thread_oopã€‚

ç„¶åå‘¢ï¼Œè°ƒç”¨äº†set_threadObj(thread_oop())æ–¹æ³•è¿›è¡Œç»‘å®šã€‚


### Javaçº¿ç¨‹çš„çŠ¶æ€ç©¶ç«Ÿæ˜¯æ€ä¹ˆä¿®æ”¹çš„ï¼Ÿ

ä¸‹é¢æ˜¯ä»¥Thread_sleep(jlong millis)ä¸ºä¾‹æ¥æŸ¥çœ‹çŠ¶æ€çš„ä¿®æ”¹è¿‡ç¨‹ï¼›

sleepçš„æ ¸å¿ƒæ–¹æ³•åœ¨äºPlatformEnvet.parkæ–¹æ³•ï¼Œè¿™ä¸ªå‰ä¸€ä¸ªæ–‡ç« å·²ç»ä»‹ç»è¿‡äº†ã€‚


æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢çš„ä»£ç  ğŸ‘‡

> ä½ç½®ï¼š hotspot\src\share\vm\prims\jvm.cpp


<img src="https://oscimg.oschina.net/oscnet/up-9eb7919bcb488c8d2bdc8518262905bfd5d.png" width=750 height=300>

æ ¸å¿ƒæ–¹æ³•åœ¨äº `JavaThreadSleepState jtss(thread)` è¿™ä¸ªæ„é€ å™¨ä¸­ã€‚


<img src="https://oscimg.oschina.net/oscnet/up-5208094374422989b704a899e277ca54c2b.png" width=750 height=200>

ä¸Šé¢æŠŠjava_threadå¯¹è±¡ç©¿è¿›å»ï¼Œç„¶åè°ƒç”¨äº†å®ƒçš„åŸºç±» JavaThreadStateChangeçš„æ„é€ æ–¹æ³•ï¼Œè¿›è¡Œjava_threadçŠ¶æ€çš„è®¾ç½®ï¼Œè¿™ä¹Ÿæ˜¯æ ¸å¿ƒæ‰€åœ¨ã€‚

é¦–å…ˆä¿å­˜çº¿ç¨‹æ—§çš„çŠ¶æ€ï¼Œç„¶ååœ¨è®¾ç½®çº¿ç¨‹æ–°çŠ¶æ€ï¼š 

<img src="https://oscimg.oschina.net/oscnet/up-2cdbf62e72112dc68dc176ca42e0f647651.png" width=750 height=100>

**é‚£ä¹ˆæ˜¯å¦‚ä½•è®¾ç½®æ–°çš„çŠ¶æ€å‘¢ï¼Ÿ**

<img src="https://oscimg.oschina.net/oscnet/up-e7dc11bb0dbf341cdca6f5720a1a43598f4.png" width=750 height=100>

**ä¸‹é¢æ˜¯set_threadStateçš„è¯¦ç»†å®ç°æ–¹æ³•ï¼š**

**è¿™é‡Œç›¸å½“äºæ˜¯C++ç¨‹åºï¼Œé¦–å…ˆè·å–threadStateå­—æ®µçš„åç§»é‡ï¼Œå› ä¸ºC++ä»£ç ä¸èƒ½ç›´æ¥æ“ä½œå †å†…å†…å­˜ã€‚æ‹¿åˆ°åç§»é‡ä¹‹åï¼Œæ›´æ”¹çŠ¶æ€çš„å€¼ã€‚**

<img src="https://oscimg.oschina.net/oscnet/up-9a8711226ad41a2dce02b7e6210e560cd80.png" width=750 height=140>

æŠŠjava_thread->threadObj()çš„çŠ¶æ€å˜æˆäº†java_long_Thread::SLEEPING

é‚£è¿™ä¸ªjava_long_Thread::SLEEPINGåœ¨C++ä¸­æ˜¯å¦‚ä½•å®šä¹‰çš„å‘¢ï¼Ÿ

<img src="https://oscimg.oschina.net/oscnet/up-fdea1c57586c8c0b9dc699ed42bd48fe8fa.png" width=750 height=330>

**Java Threadç±»ä¸­çš„threadStateçš„å€¼å°±æ˜¯åœ¨è¿™é‡Œå®šä¹‰çš„ã€‚** é‚£è¿™äº›çŠ¶æ€çš„å€¼æ˜¯ä»€ä¹ˆå‘¢ï¼Œå…¶å®è™šæ‹Ÿæœºä¸­æ ¹æ®ç³»ç»Ÿçº¿ç¨‹çš„çŠ¶æ€å®šä¹‰çš„ï¼Œä¸åŒçš„è™šæ‹Ÿæœºå¯èƒ½å®šäºçš„æœ‰æ‰€ä¸åŒã€‚

è¿™é‡Œè¯´æ˜ä¸€ä¸‹ï¼š

- é¦–å…ˆJavaçš„Threadå®šä¹‰äº†ä¸€å¥—State, Threadçš„threadStateå­—æ®µçš„å€¼å¹¶ä¸ç­‰äºå‰é¢çŠ¶æ€æšä¸¾çš„å€¼
- æ¯”å¦‚è°ƒç”¨äº†Thread.sleepæ–¹æ³•ï¼Œä¹‹åè™šæ‹Ÿæœºä¼šè®¾ç½®threadStateçš„å€¼ä¸ºæŸä¸ªå€¼
- ç„¶åè°ƒç”¨jstack -pid æŸ¥çœ‹çº¿ç¨‹çŠ¶æ€çš„æ—¶å€™ï¼Œå…¶å®æ˜¯æ ¹æ®threadStateçš„å€¼åœ¨è™šæ‹Ÿæœºä¸­å®šäºçš„é‚£ä¸€å¥—ä¸­ï¼Œæ‰¾åˆ°å¯¹åº”çš„çŠ¶æ€ï¼Œç„¶åè¾“å‡º
- æ‰€ä»¥è¯´ï¼Œjstackå‡ºæ¥çš„çº¿ç¨‹çŠ¶æ€å¹¶ä¸æ˜¯æˆ‘ä»¬Java Threadä¸­Stateæšä¸¾çš„å€¼ï¼Œè€Œä¸”ä¸åŒçš„è™šæ‹Ÿæœºå’Œä¸åŒçš„ç‰ˆæœ¬ï¼Œå¯èƒ½å®šä¹‰çš„ä¸€å¥—çŠ¶æ€å€¼æœ‰æ‰€ä¸åŒ


å¦‚ä½•è¯æ˜å‘¢ï¼Œçœ‹ä¸‹é¢ä»£ç :

<img src="https://oscimg.oschina.net/oscnet/up-f547f5cbbf6f79bc7cacf2700eaff4f3d34.png" width=750 height=370>

**é‚£Threadä¸­å®šä¹‰threadStateçš„å€¼å’ŒStateæšä¸¾çš„å€¼æœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ**

å…¶å®å¹¶ä¸æ˜¯**ç›¸ç­‰**çš„å…³ç³»

<img src="https://oscimg.oschina.net/oscnet/up-429997ff585a50019b062ed4c03e2dcbcce.png" width=750 height=330>


åˆ°è¿™é‡Œå‘¢ä»‹ç»çš„éƒ½æ˜¯C++æ“ä½œJava Threadçš„çº¿ç¨‹çŠ¶æ€ï¼Œ åŒæ—¶ï¼ŒC++ä¿®æ”¹å†…æ ¸çº¿ç¨‹çŠ¶æ€ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œè¿™é‡Œä¸åšå±•å¼€ã€‚

å…¶å®ä¹Ÿæ˜¯å®šä¹‰äº†ä¸€å¥—C++ OSThread_Stateçš„çŠ¶æ€æšä¸¾ï¼Œç„¶ååšå“åº”çš„æ˜ å°„å’Œä¿®æ”¹ã€‚



























