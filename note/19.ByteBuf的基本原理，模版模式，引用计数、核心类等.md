# 19. ByteBufçš„åŸºæœ¬åŸç†ï¼Œæ¨¡ç‰ˆæ¨¡å¼ï¼Œå¼•ç”¨è®¡æ•°ã€æ ¸å¿ƒç±»ç­‰

## ä»€ä¹ˆæ˜¯Buffer

NIOçš„Bufferæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå†…å­˜å—ï¼Œæ—¢å¯ä»¥å†™å…¥æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä»ä¸­è¯»å–æ•°æ®ã€‚Java NIOä¸­ä»£è¡¨ç¼“å†²åŒºçš„Bufferç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä½äºjava.nioåŒ…ä¸­ã€‚

NIOçš„Bufferå†…éƒ¨æ˜¯ä¸€ä¸ªå†…å­˜å—ï¼ˆæ•°ç»„ï¼‰ï¼Œä¸æ™®é€šçš„å†…å­˜å—ï¼ˆJavaæ•°ç»„ï¼‰ä¸åŒçš„æ˜¯ï¼šNIO Bufferå¯¹è±¡æä¾›äº†ä¸€ç»„æ¯”è¾ƒæœ‰æ•ˆçš„æ–¹æ³•ï¼Œç”¨æ¥è¿›è¡Œå†™å…¥å’Œè¯»å–çš„äº¤æ›¿è®¿é—®ã€‚

>  Bufferç±»æ˜¯ä¸€ä¸ªéçº¿ç¨‹å®‰å…¨ç±»ã€‚

Bufferç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå¯¹åº”äºJavaçš„ä¸»è¦æ•°æ®ç±»å‹ã€‚åœ¨NIOä¸­ï¼Œæœ‰8ç§ç¼“å†²åŒºç±»ï¼Œåˆ†åˆ«æ˜¯ByteBufferã€CharBufferã€DoubleBufferã€FloatBufferã€IntBufferã€LongBufferã€ShortBufferã€**MappedByteBuffer**ã€‚å‰7ç§Bufferç±»å‹è¦†ç›–äº†èƒ½åœ¨IOä¸­ä¼ è¾“çš„æ‰€æœ‰JavaåŸºæœ¬æ•°æ®ç±»å‹ï¼Œç¬¬8ç§ç±»å‹æ˜¯ä¸€ç§ä¸“é—¨ç”¨äºå†…å­˜æ˜ å°„çš„ByteBufferç±»å‹ã€‚ä¸åŒçš„Bufferå­ç±»å¯ä»¥æ“ä½œçš„æ•°æ®ç±»å‹èƒ½å¤Ÿé€šè¿‡åç§°è¿›è¡Œåˆ¤æ–­ï¼Œæ¯”å¦‚IntBufferåªèƒ½æ“ä½œIntegerç±»å‹çš„å¯¹è±¡ã€‚

å®é™…ä¸Šï¼Œä½¿ç”¨æœ€å¤šçš„æ˜¯ByteBufferï¼ˆäºŒè¿›åˆ¶å­—èŠ‚ç¼“å†²åŒºï¼‰ç±»å‹ï¼Œ


## Bufferç±»çš„å››ä¸ªé‡è¦å±æ€§

![](https://oscimg.oschina.net/oscnet/up-f782d6b5c02c8959ce0a48c433a57462159.png)


## Bufferæ¨¡å¼çš„è½¬æ¢å›¾

![](https://oscimg.oschina.net/oscnet/up-5caff4feec4dc09c18a8c92c672390caa36.png)


## ä½¿ç”¨Bufferç±»çš„åŸºæœ¬æ­¥éª¤

æ€»ä½“æ¥è¯´ï¼Œä½¿ç”¨Java NIO Bufferç±»çš„åŸºæœ¬æ­¥éª¤å¦‚ä¸‹ï¼š

ï¼ˆ1ï¼‰ä½¿ç”¨åˆ›å»ºå­ç±»å®ä¾‹å¯¹è±¡çš„allocate()æ–¹æ³•åˆ›å»ºä¸€ä¸ªBufferç±»çš„å®ä¾‹å¯¹è±¡ã€‚

ï¼ˆ2ï¼‰è°ƒç”¨put()æ–¹æ³•å°†æ•°æ®å†™å…¥ç¼“å†²åŒºä¸­ã€‚

ï¼ˆ3ï¼‰å†™å…¥å®Œæˆåï¼Œåœ¨å¼€å§‹è¯»å–æ•°æ®å‰è°ƒç”¨Buffer.flip()æ–¹æ³•ï¼Œå°†ç¼“å†²åŒºè½¬æ¢ä¸ºè¯»æ¨¡å¼ã€‚

ï¼ˆ4ï¼‰è°ƒç”¨get()æ–¹æ³•ï¼Œå¯ä»¥ä»ç¼“å†²åŒºä¸­è¯»å–æ•°æ®ã€‚

ï¼ˆ5ï¼‰è¯»å–å®Œæˆåï¼Œè°ƒç”¨Buffer.clear()æ–¹æ³•æˆ–Buffer.compact()æ–¹æ³•ï¼Œå°†ç¼“å†²åŒºè½¬æ¢ä¸ºå†™æ¨¡å¼ï¼Œå¯ä»¥ç»§ç»­å†™å…¥ã€‚

## NIO çš„ ByteBufferçš„å±€é™æ€§

![](https://oscimg.oschina.net/oscnet/up-18d5204ce6fb01f1b8dab95ca0b804fb9bf.png)


> Nettyçš„ByteBuf æ˜¯è‡ªå·±å°è£…çš„ä¸€ä¸ªbufferï¼Œ å¹¶æ²¡æœ‰ä½¿ç”¨NIO çš„ByteBufferï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢Bufferçš„ä¸€ç§å®ç°å­ç±» ByteBuffer  
> è¿™é‡Œææ¸…æ¥š ä¸è¦å¼„æ··æ·†å“ˆ

## Netty è‡ªå®šä¹‰äº†è‡ªå·±çš„ByteBuf

![](https://oscimg.oschina.net/oscnet/up-89845e4eaddfd91e436b8fb871ea73caa4f.png)

![](https://oscimg.oschina.net/oscnet/up-ae1f11280244e6f89e999e103f019c11019.png)


![](https://oscimg.oschina.net/oscnet/up-d8cbf7954f3e519635a23033386dee74aa8.png)


## ByteBuf ç¼“å†²åŒºçš„ç±»å‹

![](https://oscimg.oschina.net/oscnet/up-9582ba1fd49752594fb78896c8c1a6a5d90.png)

## Direct Memoryï¼ˆç›´æ¥å†…å­˜ï¼‰

- Direct Memoryä¸å±äºJavaå †å†…å­˜ï¼Œæ‰€åˆ†é…çš„å†…å­˜å…¶å®æ˜¯è°ƒç”¨æ“ä½œç³»ç»Ÿmalloc()å‡½æ•°æ¥è·å¾—çš„ï¼Œç”±Nettyçš„æœ¬åœ°Nativeå †è¿›è¡Œç®¡ç†ã€‚
- Direct Memoryå®¹é‡å¯é€šè¿‡-XX:MaxDirectMemorySizeæ¥æŒ‡å®šï¼Œå¦‚æœä¸æŒ‡å®šï¼Œåˆ™é»˜è®¤ä¸Javaå †çš„æœ€å¤§å€¼ï¼ˆ-XmxæŒ‡å®šï¼‰ä¸€æ ·ã€‚æ³¨æ„ï¼šå¹¶ä¸æ˜¯å¼ºåˆ¶è¦æ±‚ï¼Œæœ‰çš„JVMé»˜è®¤Direct Memoryä¸-Xmxå€¼æ— ç›´æ¥å…³ç³»ã€‚
- Direct Memoryçš„ä½¿ç”¨é¿å…äº†Javaå †å’ŒNativeå †ä¹‹é—´æ¥å›å¤åˆ¶æ•°æ®ã€‚åœ¨æŸäº›åº”ç”¨åœºæ™¯ä¸­æé«˜äº†æ€§èƒ½ã€‚
- **åœ¨éœ€è¦é¢‘ç¹åˆ›å»ºç¼“å†²åŒºçš„åœºåˆï¼Œç”±äºåˆ›å»ºå’Œé”€æ¯Direct Bufferï¼ˆç›´æ¥ç¼“å†²åŒºï¼‰çš„ä»£ä»·æ¯”è¾ƒé«˜æ˜‚ï¼Œå› æ­¤ä¸å®œä½¿ç”¨Direct Bufferã€‚**ä¹Ÿå°±æ˜¯è¯´ï¼ŒDirect Bufferå°½é‡åœ¨æ± åŒ–åˆ†é…å™¨ä¸­åˆ†é…å’Œå›æ”¶ã€‚å¦‚æœèƒ½å°†Direct Bufferè¿›è¡Œå¤ç”¨ï¼Œåœ¨è¯»å†™é¢‘ç¹çš„æƒ…å†µä¸‹å°±å¯ä»¥å¤§å¹…åº¦æ”¹å–„æ€§èƒ½ã€‚
- å¯¹Direct Bufferçš„è¯»å†™æ¯”Heap Bufferå¿«ï¼Œä½†æ˜¯å®ƒçš„åˆ›å»ºå’Œé”€æ¯æ¯”æ™®é€šHeap Bufferæ…¢ã€‚
- åœ¨Javaçš„åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶Javaå †æ—¶ï¼ŒNettyæ¡†æ¶ä¹Ÿä¼šé‡Šæ”¾ä¸å†ä½¿ç”¨çš„Direct Bufferç¼“å†²åŒºï¼Œå› ä¸ºå®ƒçš„å†…å­˜ä¸ºå †å¤–å†…å­˜ï¼Œæ‰€ä»¥æ¸…ç†çš„å·¥ä½œä¸ä¼šä¸ºJavaè™šæ‹Ÿæœºï¼ˆJVMï¼‰å¸¦æ¥å‹åŠ›ã€‚æ³¨æ„ä¸€ä¸‹åƒåœ¾å›æ”¶çš„åº”ç”¨åœºæ™¯ï¼šâ‘ åƒåœ¾å›æ”¶ä»…åœ¨Javaå †è¢«å¡«æ»¡ï¼Œä»¥è‡³äºæ— æ³•ä¸ºæ–°çš„å †åˆ†é…è¯·æ±‚æä¾›æœåŠ¡æ—¶å‘ç”Ÿï¼›â‘¡åœ¨Javaåº”ç”¨ç¨‹åºä¸­è°ƒç”¨System.gc()å‡½æ•°æ¥é‡Šæ”¾å†…å­˜


## Heap ByteBufå’ŒDirect ByteBufä¸¤ç±»ç¼“å†²åŒºçš„ä½¿ç”¨ï¼Œå®ƒä»¬æœ‰ä»¥ä¸‹å‡ ç‚¹ä¸åŒï¼š

- Heap ByteBufé€šè¿‡è°ƒç”¨åˆ†é…å™¨çš„buffer()æ–¹æ³•æ¥åˆ›å»ºï¼›
- Direct ByteBufé€šè¿‡è°ƒç”¨åˆ†é…å™¨çš„directBuffer()æ–¹æ³•æ¥åˆ›å»ºã€‚
- Heap ByteBufç¼“å†²åŒºå¯ä»¥ç›´æ¥é€šè¿‡array()æ–¹æ³•è¯»å–å†…éƒ¨æ•°ç»„ï¼›
- Direct ByteBufç¼“å†²åŒºä¸èƒ½è¯»å–å†…éƒ¨æ•°ç»„ã€‚
- å¯ä»¥è°ƒç”¨hasArray()æ–¹æ³•æ¥åˆ¤æ–­æ˜¯å¦ä¸ºHeap ByteBufç±»å‹çš„ç¼“å†²åŒºï¼›å¦‚æœhasArray()è¿”å›å€¼ä¸ºtrueï¼Œåˆ™è¡¨ç¤ºæ˜¯å †ç¼“å†²ï¼Œå¦åˆ™ä¸ºç›´æ¥å†…å­˜ç¼“å†²åŒºã€‚
- ä»Direct ByteBufè¯»å–ç¼“å†²æ•°æ®è¿›è¡ŒJavaç¨‹åºå¤„ç†æ—¶ï¼Œç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œéœ€è¦é€šè¿‡getBytes/readBytesç­‰æ–¹æ³•å…ˆå°†æ•°æ®å¤åˆ¶åˆ°Javaçš„å †å†…å­˜ï¼Œç„¶åè¿›è¡Œå…¶ä»–çš„è®¡ç®—ã€‚

## Unpooledæä¾›äº†å¾ˆå¤šæ–¹æ³•

![](https://oscimg.oschina.net/oscnet/up-0ded3cee5ad451530499812c9f47aca80df.png)


```java
//åˆ›å»ºå †ç¼“å†²åŒº
ByteBuf heapBuf = Unpooled.buffer(8);
//åˆ›å»ºç›´æ¥ç¼“å†²åŒº
ByteBuf directBuf = Unpooled.directBuffer(16);
//åˆ›å»ºå¤åˆç¼“å†²åŒº
CompositeByteBuf compBuf = Unpooled.compositeBuffer();
```

![](https://oscimg.oschina.net/oscnet/up-29817fb8b5e4d53fe56f4dea69dc89770ab.png)

![](https://oscimg.oschina.net/oscnet/up-dc4d1a8b77010763451758398256b481bb0.png)

![](https://oscimg.oschina.net/oscnet/up-52ded7e5fbf8f3c0f3cb2d5842015bbbeda.png)

![](https://oscimg.oschina.net/oscnet/up-6c288e90bcbefc1684fc6caa399f540e838.png)


![](https://oscimg.oschina.net/oscnet/up-0d30b2485d3efd34db3535c3e4d174b1c7c.png)


```java
public static void main(String[] args) {
        ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer();
        System.err.println("after create  " + buffer.refCnt());

        buffer.retain();
        System.err.println("after retain  " + buffer.refCnt());

        buffer.release();
        System.err.println("after release  " + buffer.refCnt());

        buffer.release();
        System.err.println("after release  " + buffer.refCnt());

        buffer.retain();
        System.err.println("after retain  " + buffer.refCnt());
    }
```
æµ‹è¯•ç»“æœï¼š 

```text
after create  1
after retain  2
after release  1
after release  0
Exception in thread "main" io.netty.util.IllegalReferenceCountException: refCnt: 0, increment: 1
	at io.netty.buffer.AbstractReferenceCountedByteBuf.retain0(AbstractReferenceCountedByteBuf.java:100)
	at io.netty.buffer.AbstractReferenceCountedByteBuf.retain(AbstractReferenceCountedByteBuf.java:87)
	at com.ibli.netty.demo.ByteBufTest.main(ByteBufTest.java:26)
```

> retain å’Œ release ä¸¤ä¸ªæ–¹æ³•å¿…é¡»ç»“é˜Ÿä½¿ç”¨  
>


##   å¦‚ä½•ä¿è¯refCountå­—æ®µçš„åŸå­æ€§
![](https://oscimg.oschina.net/oscnet/up-a0130a7ca0f2d28fafa9877bedd5a2dc23d.png)

ä¸‹é¢æ˜¯æºç  ğŸ‘‡

![](https://oscimg.oschina.net/oscnet/up-e4a4fd0a4ecad0afc2040a8961fe9d6b653.png)

çœ‹åˆ°è¿™é‡Œåº”è¯¥èƒ½çŒœæƒ³å‡ºæ¥ï¼Œretain æ–¹æ³•å’Œrelease ä¸¤ä¸ªæ–¹æ³•çš„å†…éƒ¨å®ç°äº†å§ ? 

### retainæ–¹æ³•æºç å®ç°
```java
private ByteBuf retain0(int increment) {
        int adjustedIncrement = increment << 1;
        int oldRef = refCntUpdater.getAndAdd(this, adjustedIncrement);
        if ((oldRef & 1) != 0) {
            throw new IllegalReferenceCountException(0, increment);
        } else if ((oldRef > 0 || oldRef + adjustedIncrement < 0) && (oldRef < 0 || oldRef + adjustedIncrement >= oldRef)) {
            return this;
        } else {
            refCntUpdater.getAndAdd(this, -adjustedIncrement);
            throw new IllegalReferenceCountException(realRefCnt(oldRef), increment);
        }
    }
```

### releaseæ–¹æ³•æºç 
```java
 private boolean release0(int decrement) {
        int rawCnt = this.nonVolatileRawCnt();
        int realCnt = toLiveRealCnt(rawCnt, decrement);
        if (decrement == realCnt) {
            if (refCntUpdater.compareAndSet(this, rawCnt, 1)) {
                this.deallocate();
                return true;
            } else {
                return this.retryRelease0(decrement);
            }
        } else {
            return this.releaseNonFinal0(decrement, rawCnt, realCnt);
        }
    }
```

## æ´¾ç”Ÿç¼“å†²åŒºçš„é›†æˆå…³ç³»
æ´¾ç”Ÿç¼“å†²åŒºä¼šäº§ç”Ÿè‡ªå·±çš„è¯»å†™ç´¢å¼•å’Œå…¶ä»–ç´¢å¼•ï¼Œä½†ä¸åŸå£°çš„ç¼“å†²åŒºå…±äº«å†…éƒ¨çš„æ•°æ®
![](https://oscimg.oschina.net/oscnet/up-b2e531270aee726f18d71c00007d94593e6.png)

æµ…å±‚å¤åˆ¶æ–¹æ³•ä¸ä¼šå®é™…å»å¤åˆ¶æ•°æ®ï¼Œä¹Ÿä¸ä¼šæ”¹å˜ByteBufçš„å¼•ç”¨è®¡æ•°ï¼Œä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼šåœ¨æºByteBufè°ƒç”¨release()æ–¹æ³•ä¹‹åï¼Œä¸€æ—¦å¼•ç”¨è®¡æ•°ä¸ºé›¶ï¼Œå°±å˜å¾—ä¸èƒ½è®¿é—®äº†ï¼›åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼ŒæºByteBufçš„æ‰€æœ‰æµ…å±‚å¤åˆ¶å®ä¾‹ä¹Ÿä¸èƒ½è¿›è¡Œè¯»å†™äº†ï¼›å¦‚æœå¼ºè¡Œå¯¹æµ…å±‚å¤åˆ¶å®ä¾‹è¿›è¡Œè¯»å†™ï¼Œåˆ™ä¼šæŠ¥é”™ã€‚

å› æ­¤ï¼Œåœ¨è°ƒç”¨æµ…å±‚å¤åˆ¶å®ä¾‹æ—¶ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ä¸€æ¬¡retain()æ–¹æ³•æ¥å¢åŠ å¼•ç”¨ï¼Œè¡¨ç¤ºå®ƒä»¬å¯¹åº”çš„åº•å±‚å†…å­˜å¤šäº†ä¸€æ¬¡å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°ä¸º2ã€‚åœ¨æµ…å±‚å¤åˆ¶å®ä¾‹ç”¨å®Œåï¼Œéœ€è¦è°ƒç”¨ä¸¤æ¬¡release()æ–¹æ³•ï¼Œå°†å¼•ç”¨è®¡æ•°å‡1ï¼Œè¿™æ ·å°±ä¸ä¼šå½±å“æºByteBufçš„å†…å­˜é‡Šæ”¾äº†



















